<?xml version="1.0"?>
<root BTCPP_format="4" >
    <BehaviorTree ID="main_bt">
        <Sequence name="root_sequence">
            <Fallback name="lidar_fallback">
                <LidarCheck name="lidar_check"/>
                <Sequence name="lidar_first_recover_seq">
                    <SpeedReduce name="speed_reduce"/>
                    <LidarRestart name="lidar_restart"/>
                    <SpeedRestore name="speed_restore"/>
                </Sequence>
                <Sequence name="lidar_second_recover_seq">
                    <FullStop name="full_stop"/>
                    <RetryUntilSuccessful num_attempts="2">
                        <LidarRestart name="lidar_restart"/>
                    </RetryUntilSuccessful>
                    <SpeedRestore name="speed_restore"/>
                </Sequence>
                <Sequence name="lidar_complete_failure_seq">
                    <CancelTask name="cancel_task"/>
                    <SetLidarFailureState name="set_lidar_failure_state"/>
                </Sequence>
            </Fallback>
            <Fallback name="imu_fallback">
                <ImuCheck name="imu_check"/>
                <Sequence name="imu_first_recover_seq">
                    <SpeedReduce name="speed_reduce"/>
                    <ImuRestart name="imu_restart"/>
                    <SpeedRestore name="speed_restore"/>
                </Sequence>
                <Sequence name="imu_second_recover_seq">
                    <FullStop name="full_stop"/>
                    <RetryUntilSuccessful num_attempts="2">
                        <ImuRestart name="imu_restart"/>
                    </RetryUntilSuccessful>
                    <SpeedRestore name="speed_restore"/>
                </Sequence>
                <Sequence name="imu_complete_failure_seq">
                    <CancelTask name="cancel_task"/>
                    <SetImuFailureState name="set_imu_failure_state"/>
                </Sequence>
            </Fallback>
            <Fallback name="odom_fallback">
                <OdomCheck name="odom_check"/>
                <Sequence name="odom_first_recover_seq">
                    <SpeedReduce name="speed_reduce"/>
                    <OdomRestart name="odom_restart"/>
                    <SpeedRestore name="speed_restore"/>
                </Sequence>
                <Sequence name="odom_second_recover_seq">
                    <FullStop name="full_stop"/>
                    <RetryUntilSuccessful num_attempts="2">
                        <OdomRestart name="odom_restart"/>
                    </RetryUntilSuccessful>
                    <SpeedRestore name="speed_restore"/>
                </Sequence>
                <Sequence name="odom_complete_failure_seq">
                    <CancelTask name="cancel_task"/>
                    <SetOdomFailureState name="set_odom_failure_state"/>
                </Sequence>
            </Fallback>
            <Fallback name="battery_fallback">
                <BatteryCheck name="battery_check"/>
                <Sequence name="insufficient_battery_seq">
                    <FullStop ID="full_stop"/>
                    <CancelTask ID="cancel_task"/>
                </Sequence>
            </Fallback>
            <Fallback name="path_fallback">
                <Sequence name="global_planner_check_seq">
                    <Inverter>
                        <GlobalPlannerCheck name="global_planner_check"/>
                    </Inverter>
                    <GlobalPlannerRestart name="global_planner_restart"/>
                </Sequence>
                <PathPossibilityCheck name="path_possibility_check"/>
                <Sequence name="path_impossible_seq">
                    <FullStop name="full_stop"/>
                    <CancelTask name="cancel_task"/>
                    <SetPathFailureState name="set_path_failure_state"/>
                </Sequence>
            </Fallback>
            <Fallback name="collision_fallback">
                <CollisionCheck name="collision_check"/>
                <Sequence name="collision_handle_seq">
                    <FullStop name="full_stop"/>
                    <CancelTask name="cancel_task"/>
                    <Fallback name="reset_map_fallback">
                        <Sequence name="slam_reset_seq">
                            <SlamCheck name="slam_check"/>
                            <ResetMap ID="reset_map"/>
                        </Sequence>
                        <Sequence name="map_update_seq">
                            <UpdateMap name="update_map"/>
                            <SaveMap name="save_map"/>
                            <LoadMap name="load_map"/>
                        </Sequence>
                    </Fallback>
                    <KeepRunningUntilFailure>
                        <Inverter>
                            <OrientationCheck name="orientation_check"/>
                        </Inverter>
                    </KeepRunningUntilFailure>
                    <Sequence>
                        <Fallback name="lidar_fallback">
                            <LidarCheck name="lidar_check"/>
                            <Sequence name="lidar_first_recover_seq">
                                <SpeedReduce name="speed_reduce"/>
                                <LidarRestart name="lidar_restart"/>
                                <SpeedRestore name="speed_restore"/>
                            </Sequence>
                            <Sequence name="lidar_second_recover_seq">
                                <FullStop name="full_stop"/>
                                <RetryUntilSuccessful num_attempts="2">
                                    <LidarRestart name="lidar_restart"/>
                                </RetryUntilSuccessful>
                                <SpeedRestore name="speed_restore"/>
                            </Sequence>
                            <Sequence name="lidar_complete_failure_seq">
                                <CancelTask name="cancel_task"/>
                                <SetLidarFailureState name="set_lidar_failure_state"/>
                            </Sequence>
                        </Fallback>
                        <Fallback name="imu_fallback">
                            <ImuCheck name="imu_check"/>
                            <Sequence name="imu_first_recover_seq">
                                <SpeedReduce name="speed_reduce"/>
                                <ImuRestart name="imu_restart"/>
                                <SpeedRestore name="speed_restore"/>
                            </Sequence>
                            <Sequence name="imu_second_recover_seq">
                                <FullStop name="full_stop"/>
                                <RetryUntilSuccessful num_attempts="2">
                                    <ImuRestart name="imu_restart"/>
                                </RetryUntilSuccessful>
                                <SpeedRestore name="speed_restore"/>
                            </Sequence>
                            <Sequence name="imu_complete_failure_seq">
                                <CancelTask name="cancel_task"/>
                                <SetImuFailureState name="set_imu_failure_state"/>
                            </Sequence>
                        </Fallback>
                        <Fallback name="odom_fallback">
                            <OdomCheck name="odom_check"/>
                            <Sequence name="odom_first_recover_seq">
                                <SpeedReduce name="speed_reduce"/>
                                <OdomRestart name="odom_restart"/>
                                <SpeedRestore name="speed_restore"/>
                            </Sequence>
                            <Sequence name="odom_second_recover_seq">
                                <FullStop name="full_stop"/>
                                <RetryUntilSuccessful num_attempts="2">
                                    <OdomRestart name="odom_restart"/>
                                </RetryUntilSuccessful>
                                <SpeedRestore name="speed_restore"/>
                            </Sequence>
                            <Sequence name="odom_complete_failure_seq">
                                <CancelTask name="cancel_task"/>
                                <SetOdomFailureState name="set_odom_failure_state"/>
                            </Sequence>
                        </Fallback>
                        <Fallback name="battery_fallback">
                            <BatteryCheck name="battery_check"/>
                            <Sequence name="insufficient_battery_seq">
                                <FullStop ID="full_stop"/>
                                <CancelTask ID="cancel_task"/>
                            </Sequence>
                        </Fallback>
                        <Fallback>
                            <CollisionCheck name="collision_check"/>
                            <SetCollisionFailureState name="set_collision_failure_state"/>
                        </Fallback>
                        <PublishLastGoal name="publish_last_goal"/>
                    </Sequence>
                </Sequence>
            </Fallback>
        </Sequence>
    </BehaviorTree>

    <!-- the BT executor don't require this, but Groot does -->     
    <TreeNodeModel>
        <Condition ID="LidarCheck"/>
        <Action ID="LidarRestart"/>
        <Action ID="SetLidarFailureState"/>

        <Condition ID="ImuCheck"/>
        <Action ID="ImuRestart"/>
        <Action ID="SetImuFailureState"/>

        <Condition ID="OdomCheck"/>
        <Action ID="OdomRestart"/>
        <Action ID="SetOdomFailureState"/>

        <Condition ID="BatteryCheck"/>

        <Condition ID="GlobalPlannerCheck"/>
        <Action ID="GlobalPlannerRestart"/>
        <Action ID="SetPathFailureState"/>

        <Action ID="PathPossibilityCheck"/>

        <Condition ID="CollisionCheck"/>
        <Action ID="set_collision_failure_state"/>

        <Condition ID="OrientationCheck"/>
        <Condition ID="SlamCheck"/>

        <Action ID="ResetMap"/>
        <Action ID="UpdateMap"/>
        <Action ID="SaveMap"/>
        <Action ID="LoadMap"/>

        <Action ID="SpeedReduce"/>
        <Action ID="SpeedRestore"/>
        <Action ID="FullStop"/>

        <Action ID="CancelTask"/> 
    </TreeNodeModel>
</root>